#! /bin/bash

BACKUP=/home/alberto/.local/bin/backup
CONFIG=/home/alberto/.config/backup
LOG_FILE=

HOST=oneplus2
OWNER=alberto

OUT_PATH=/media/live-backups
ANDROID_PATH=/sdcard

ANDROID_USER=user
ANDROID_IP=192.168.1.37
ANDROID_PORT=2222
ANDROID_PRIVATE_KEY=/home/alberto/.ssh/android

OUT_DEV=/dev/mapper/ext--seaport--vg-live--backups


function log() {
	#echo -e "$(date +'%Y-%m-%d %H:%M:%S') $1" | tee -a "$LOG_FILE"
	echo -e "$(date +'%Y-%m-%d %H:%M:%S') $1"
}

function do_backup() {
	log "Starting backup of Android"
	$BACKUP --src "$ANDROID_USER@$ANDROID_IP:$ANDROID_PATH" --dst "$OUT_PATH/$HOST" -e "ssh -i $ANDROID_PRIVATE_KEY -p $ANDROID_PORT" --filter "$CONFIG/backup-android.filter" --owner "$OWNER" 2>&1
}

function check_root() {
	if [ "$EUID" -ne 0 ]; then
		echo "You need to be root to mount filesystems. Please execute again with sudo"
		exit 1
	fi
}

function verify_external_disk_connected() {
	if [ ! -b "$OUT_DEV" ]; then
		log "The external disk is not connected or it is not decrypted"
		exit 1
	fi
}

function verify_out_partition_mounted() {
	if ! grep -qs "$OUT_PATH" /proc/mounts; then
		log "The output partition is not mounted"
		exit 1
	fi
}

function verify_android_ssh_connection() {
	ssh -q -i "$ANDROID_PRIVATE_KEY" -p "$ANDROID_PORT" "$ANDROID_USER@$ANDROID_IP" exit
	if [ $? -ne 0 ]; then
		log "Imposible to connect to the Android device via ssh"
		exit 1
	fi
}

verify_external_disk_connected
verify_out_partition_mounted
verify_android_ssh_connection
do_backup

log "Finished"
